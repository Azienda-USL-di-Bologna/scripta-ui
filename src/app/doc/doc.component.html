<p-toast #pageStart position="top-right" (onClose)="clearMessages()"></p-toast>
<p-toolbar *ngIf="docVisualizer?.numera">
  <div class="classe-temporanea">
    <button  *ngIf="!numeroVisualizzazione" pButton type="button" label="Protocolla"icon="material-icons-outlined person_add"
      (click)="doButtonProtocolla()">
    </button>
  </div>
</p-toolbar>
<p-progressBar *ngIf="inProtocollazione" mode="indeterminate"></p-progressBar>
<p-blockUI [blocked]="blockedDocument">
  <i class="pi pi-lock" style="font-size: 3rem"></i>
</p-blockUI>

<p-overlayPanel #opNoteAnnullamento>
  <ng-template pTemplate>
    <textarea #notaAnnullamento
      pInputTextarea 
      id="notaAnnullamento" 
      aria-label="notaAnnullamento" 
      class="oggetto" 
      placeholder="Inserisci la nota annullamento"
      rows="2" cols="30"
      [(ngModel)]="notaAnnullamentoString" 
      disabled ="!docVisualizer?.editing">
        <!-- (keyup)="timeOutAndSaveDoc(doc, 'oggetto')" --> 
  </textarea>  
  </ng-template>
</p-overlayPanel>
<p-overlayPanel #opNoteDocumento>
  <ng-template pTemplate>
    <textarea #notaDocumento
      pInputTextarea 
      id="notaDocumento" 
      aria-label="notaDocumento" 
      class="oggetto" 
      placeholder="Inserisci la nota docuemnto"
      rows="2" cols="30"
      [(ngModel)]="notaDocumentoString" 
      disabled ="!docVisualizer?.editing">
        <!-- (keyup)="timeOutAndSaveDoc(doc, 'oggetto')" --> 
  </textarea>  
  </ng-template>
</p-overlayPanel>

<main class="main-content" aria-level="2" *ngIf="!!doc" [ngClass]="{'main-left' : pregresso}"> <!-- -->
<section class="info-documento">
  <p-fieldset legend="Dati del Documento" *ngIf="docVisualizer?.datiDoc">
    <div *ngIf="!visualizzazioneDocumento" class="m-bottom-05"> 
      <span *ngIf="!numeroVisualizzazione">Proposta numero {{doc?.id}} del {{yearOfProposta}}</span>
      <span *ngIf="numeroVisualizzazione">{{registroLabel}} {{numeroVisualizzazione}} </span>
    </div>
    <div class="oggetto-and-additional-info-box">

      <div class="oggetto-box" *ngIf="docVisualizer?.oggetto">
        <label for="oggetto" class="label-oggetto">Oggetto</label>
        <textarea id="oggetto" *ngIf="doc" aria-label="oggetto" class="oggetto" pInputTextarea placeholder="Inserisci l'oggetto"
          rows="2" cols="30" (keyup)="timeOutAndSaveDoc(doc, 'oggetto')" [(ngModel)]="doc.oggetto" disabled ="!docVisualizer?.editing">
        </textarea>
      </div>
      <div class="additional-info-box">
        <div class="visibilita-limitata">
          <i class="pi pi-eye" 
            *ngIf="docVisualizer?.visibilitaLimitata"
            pTooltip="Visibilita Limitata"></i>
          <p-checkbox *ngIf="docVisualizer?.editing" id="visibilitaLimitata" [(ngModel)]="visibilitaLimitata" [binary]="true" [readonly]="pregresso" [disabled]="pregresso" class="checkbox"></p-checkbox>
          <label *ngIf="docVisualizer?.editing" for="visibilitaLimitata">Visibilita Limitata</label>
        </div>
        <div class="riservato">
          <i *ngIf="docVisualizer?.riservato"
            class="pi pi-eye-slash" 
            pTooltip="Riservato"></i>
          <p-checkbox *ngIf="docVisualizer?.editing" 
            id="riservato" 
            [(ngModel)]="riservato" 
            [binary]="true" 
            [readonly]="pregresso" 
            [disabled]="pregresso" 
            class="checkbox"></p-checkbox>
          <label *ngIf="docVisualizer?.editing" for="riservato">Riservato</label>
        </div>
        <div class="annullato">
          <i *ngIf="docVisualizer?.annullato"
            pTooltip="Nota Annullamento"
            class="pi pi-exclamation-triangle" 
            (click)="opNoteAnnullamento.show($event)">
          </i>
          <p-checkbox  *ngIf="docVisualizer?.editing" 
            id="annullato" 
            [(ngModel)]="annullato" 
            [binary]="true" 
            [readonly]="pregresso" 
            [disabled]="pregresso" 
            class="checkbox"></p-checkbox>
          <label *ngIf="docVisualizer?.editing" for="annullato">Annullato</label>
        </div>
        <div class="noteDoc">
          <i *ngIf="docVisualizer?.note"
            ptooltip="Note documento"
            class="pi pi-book" 
            (click)="opNoteDocumento.show($event)">
          </i>
        </div>
      </div>
    </div> 

    <div class="dati-generici m-bottom-5">
      <div class="sotto-dati-generici-date">
        <div class="data-versamento">
          <label class="label-oggetto">Data Creazione</label>
          <input id="dataCreazione" aria-label="data" disabled="true" type="text" 
            [(ngModel)]="dataCreazione">
        </div>
        <div class="data-registrazione">
          <label for="dataRegistrazione">Data Registrazione</label>
          <input id="dataRegistrazione" aria-label="data" disabled="true" type="text"
          [(ngModel)]="dataRegistrazione">
        </div>
        <div class="data-versamento">
          <label for="dataUltimoVersamento" class="label-oggetto">Data Ultimo Versamento</label>
          <input id="dataUltimoVersamento" aria-label="data" disabled="true" type="text" 
            [(ngModel)]="dataUltimoVersamento">
        </div>
      </div>
      <!-- TODO: Tutti i flag andranno disabilitati/abilitati anche in base alla registrazione del documento -->
    </div>
    
    <div class="protocollato-da-box" m-bottom-5>
      <label>Creato da: </label>
      <input id="creatoDa" *ngIf="docVisualizer?.creatoDa" aria-label="creato da" disabled="true" pInputText type="text" [disabled]="true"
        [(ngModel)]="doc.idPersonaCreazione.descrizione">
    </div>
    <div class="protocollato-da-box" m-bottom-5>
      <label for="protocollatoda">{{protocollatoDaLabel}}</label>
      <input id="protocollatoda" *ngIf="doc.tipologia != 'DELIBERA' && doc.tipologia != 'DETERMINA'" aria-label="protocollato da" disabled="true" pInputText type="text" [disabled]="pregresso"
        [(ngModel)]="descrizioneUtenteRegistrante">
      <input *ngIf="doc.tipologia === 'DELIBERA' || doc.tipologia === 'DETERMINA'" id="protocollatoda" aria-label="adottato da" disabled="true" pInputText type="text" [disabled]="pregresso"
        [(ngModel)]="descrizioneStrutturaAdottante">
    </div>
  </p-fieldset>
  <p-accordion [multiple]="true">
    <p-accordionTab *ngIf="tipoDocumento === 'PROTOCOLLO_IN_ENTRATA'" header="Mittente" [selected]="true">
      <mittente [doc]="doc" [tipoDocumento]="tipoDocumento" (saveMittenteEvent)="saveDoc($event,'mittenti')"></mittente>
    </p-accordionTab>
    <p-accordionTab *ngIf="docVisualizer?.attori" header="Attori">
      <ng-template pTemplate="content">
        <attori [doc]="doc"></attori>
      </ng-template>
    </p-accordionTab>
    <p-accordionTab *ngIf="docVisualizer?.destinatari" header="Destinatari" [selected]="tipoDocumento !== 'PROTOCOLLO_IN_ENTRATA'">
      <ng-template pTemplate="content">
        <destinatari [doc]="doc"> </destinatari>
      </ng-template>
    </p-accordionTab>
    <p-accordionTab *ngIf="docVisualizer?.pubblicazioni" header="Pubblicazioni">
      <ng-template pTemplate="content">
        <dati-pubblicazione [doc]="doc"></dati-pubblicazione>
      </ng-template>
    </p-accordionTab>
    <p-accordionTab *ngIf="docVisualizer?.fascicolo" header="Fascicolazioni">
      <ng-template pTemplate="content">
        <archivio-doc [doc]="doc"></archivio-doc>
      </ng-template>
    </p-accordionTab>
    <p-accordionTab *ngIf="docVisualizer?.allegatiPeis" header="Allegati" class="allegati-tab">
      <ng-template pTemplate="content">
        <allegati [doc]="doc"></allegati>
      </ng-template>
    </p-accordionTab>
  </p-accordion>
</section>
<!-- 
  Commento da non cancellare. Sono campi che in futuro potremmo voler utilizzare
  <div class="protocollo-esterno-box p-grid">
  <label class="p-col-3" id="datiProtocolloEsterno">Dati protocollo Esterno</label>
  <p-inputNumber
          ariaLabel="numero protocollo esterno"
          [disabled]="false"
          id="p-datiProtocolloEsterno"
          inputId="datiProtocolloEsterno"
          [(ngModel)]="DatiProtocolloEsterno"
          class="p-col">
  </p-inputNumber>
  <label class="p-col-2" for="c-dataProtocollazione">del</label>
  <span class="p-col-2" id="dataProtocollazione" style ="display:none;" >data di protocollazione esterna</span>
  <p-calendar
          #CdataProtocolloEsterno
          id="c-dataProtocollazione"
          attr.aria-labelledby="dataProtocollazione"
          [ariaLabelledBy]="'dataProtocollazione'"
          [(ngModel)]="dataProtocolloEsterno"
          dateFormat="dd/mm/yy"
          [locale]="localIt"
          [showIcon]="true"
          inputId="dataProtocollazione"
          appendTo="body"
          class="p-col">
  </p-calendar>
</div> -->
<section *ngIf="docVisualizer?.allegatiPreg">
  <label class="allegati-label">Allegati</label>
  <attachments-box
    [idDoc]="doc.id"
    [config]="attachmentsBoxConfig">
  </attachments-box>
</section>
</main>